{%- liquid
  # O snippet às vezes recebe `card_product`, outras vezes `product`.
  assign p = card_product
  if p == blank
    assign p = product
  endif

  # Garante valores-padrão para evitar erros de nil
  assign price      = 0
  assign compare_at = 0

  if p != blank
    assign price      = p.price
    assign compare_at = p.compare_at_price_max
  endif

  # Verifica se o produto está em pré-venda (metafield custom.pre-venda == true)
  assign presale = false
  if p != blank and p.metafields.custom['pre-venda']
    if p.metafields.custom['pre-venda'] == true or p.metafields.custom['pre-venda'].value == true
      assign presale = true
    endif
  endif
-%}

<div
  class="product-badges product-badges--{{ settings.badge_position }}"
  style="
    --badge-border-radius: {{ settings.badge_corner_radius }}px;
    --badge-font-family: var(--font-{{ settings.badge_font_family }}--family);
    --badge-font-weight: var(--font-{{ settings.badge_font_family }}--weight);
    --badge-text-transform: {{ settings.badge_text_transform }};
  "
>
  {%- if presale -%}
    <!-- Badge “Pré-venda” -->
    <div
      class="product-badges__badge product-badges__badge--rectangle product-badges__badge--pre-venda"
    >
      Pré-venda
    </div>
  {%- endif -%}

  {%- unless p.available -%}
    <!-- Badge “Sold Out” -->
    <div
      class="product-badges__badge product-badges__badge--rectangle color-{{ settings.badge_soldout_color_scheme }}"
    >
      {{ 'content.product_badge_sold_out' | t }}
    </div>
  {%- endunless -%}

  {%- if p.available and compare_at > price -%}
    {%- assign discount_raw = compare_at | minus: price -%}
{%- assign discount_percent = discount_raw | times: 100.0 | divided_by: compare_at | round -%}

    <div
      class="product-badges__badge product-badges__badge--rectangle color-{{ settings.badge_sale_color_scheme }}"
    >
      {{ discount_percent }}% OFF
    </div>
  {%- endif -%}
</div>

{% stylesheet %}
  .product-badges {
    position: absolute;
    z-index: var(--layer-flat);
    --badge-inset: max(var(--padding-xs), calc((var(--border-radius) + var(--padding-xs)) * (1 - cos(45deg))));
  }

  .product-badges--bottom-left { bottom: calc(var(--badge-inset) + var(--padding-block-start)); left: calc(var(--badge-inset) + var(--padding-inline-start)); }
  .product-badges--top-left    { top:    calc(var(--badge-inset) + var(--padding-block-start)); left: calc(var(--badge-inset) + var(--padding-inline-start)); }
  .product-badges--top-right   { top:    calc(var(--badge-inset) + var(--padding-block-start)); right: calc(var(--badge-inset) + var(--padding-inline-start)); }

  .product-badges__badge {
    --badge-font-size: var(--font-size--xs);
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    color: #000;
    background: #dce356;
    font-size: 11px;
    font-family: var(--badge-font-family);
    font-weight: bold;
    text-transform: var(--badge-text-transform);
    border-radius: 0;
  }

  .product-badges__badge--rectangle { padding: 2px 6px; }

  /* ---------- Nova badge “Pré-venda” ---------- */
  .product-badges__badge--pre-venda {
    position: relative;               /* necessário para o efeito shiny */
    overflow: hidden;                 /* esconde o brilho fora da badge */
    background: var(--badge-presale-background, #ff6600);
    color: var(--badge-presale-color, #ffffff);
  }

  /* Barra de brilho vertical que atravessa a badge clareando o fundo */
  .product-badges__badge--pre-venda::after {
    content: '';
    position: absolute;
    top: -100%;                       /* inicia acima da badge */
    left: 0;
    width: 100%;
    height: 200%;                     /* cobre a badge toda durante o percurso */
    background: linear-gradient(
      0deg,
      transparent 0%,
      rgba(255,255,255,0.35) 50%,
      transparent 100%
    );
    animation: presale-shine 2.8s linear infinite;
    mix-blend-mode: screen;           /* clareia levemente onde passa */
    pointer-events: none;             /* não interfere em cliques */
  }

  @keyframes presale-shine {
    0%   { transform: translateY(-100%); }
    100% { transform: translateY(100%); }
  }
{% endstylesheet %}
