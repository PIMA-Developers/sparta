{%- doc -%}
  Addon block within _flow-product-form. Two modes:
  - product: cards with checkbox/toggle + quantity. Products via product_list.
  - service: simple toggles. Hidden in cart (private property _service_type),
    visible in checkout. Uses _display_name for consistent naming.

  DOM contract (see plan sec. 5.1):
    data-flow-addon, data-addon-type (product|service)
    Per item: data-addon-variant-id, data-addon-quantity, data-addon-selected
    Service extras: data-service-property-key, data-service-property-value, data-service-display-name
    Price: data-price (in cents)

  @param {select} addon_type - product | service
  @param {product_list} products - Products to show as addons (product type)
  @param {select} display_style - card | compact | collapsible_select
  @param {select} activation_method - checkbox | toggle
  @param {checkbox} show_quantity - Show quantity selector (product type only)
  @param {text} service_property_key - Property key for service (default: _service_type)
  @param {text} service_display_name - Display name override for cart/step
{%- enddoc -%}


{%- liquid
  assign addon_type = block.settings.addon_type | default: 'product'
  assign display_style = block.settings.display_style | default: 'card'
  assign activation = block.settings.activation_method | default: 'checkbox'
-%}


<div
  class="flow-addon flow-addon--{{ addon_type }} flow-addon--{{ display_style }}"
  {{ block.shopify_attributes }}
  data-flow-addon
  data-addon-type="{{ addon_type }}"
  data-selection-mode="{{ block.settings.selection_mode | default: 'any' }}"
  data-variant-card-layout="{{ block.settings.variant_card_layout | default: 'compact' }}"
  style="
  --flow-badge-pad-y: {{ block.settings.badge_padding_y | default: 2 }}px;
  --flow-badge-pad-x: {{ block.settings.badge_padding_x | default: 8 }}px;
  --flow-badge-gap: {{ block.settings.badge_gap | default: 6 }}px;
  --flow-badge-radius: {{ block.settings.badge_radius | default: 12 }}px;
  --flow-addon-variant-cols-mobile: {{ block.settings.variant_columns_mobile | default: 2 }};
  --flow-addon-variant-cols-desktop: {{ block.settings.variant_columns_desktop | default: 3 }};
  "
>
  {%- if block.settings.heading != blank -%}
    <h3 class="flow-addon__heading">{{ block.settings.heading }}</h3>
  {%- endif -%}

  <div class="flow-addon__items">
    {%- if addon_type == 'product' -%}
      {%- assign badges_lines = block.settings.badges_config | strip_html | replace: '\r', '' | split: '\n' -%}
      {%- for addon_product in block.settings.products -%}
        {%- assign addon_variant = addon_product.selected_or_first_available_variant -%}
        {%- if addon_variant -%}
          {%- assign has_multiple_variants = false -%}
          {%- if addon_product.variants.size > 1 -%}
            {%- assign has_multiple_variants = true -%}
          {%- endif -%}
          {%- assign use_collapsible_select = false -%}
          {%- if display_style == 'collapsible_select' and has_multiple_variants -%}
            {%- assign use_collapsible_select = true -%}
          {%- endif -%}
          {%- assign pre_pos = block.settings.preselected_position | default: 0 | plus: 0 -%}
          {%- assign is_preselected = false -%}
          {%- if pre_pos > 0 and forloop.index == pre_pos -%}
            {%- assign is_preselected = true -%}
          {%- endif -%}
          <div
            class="flow-addon__item flow-addon__item--product{% if use_collapsible_select %} flow-addon__item--collapsible{% endif %}"
            data-addon-variant-id="{{ addon_variant.id }}"
            data-addon-quantity="1"
            data-addon-selected="{% if is_preselected %}true{% else %}false{% endif %}"
            data-price="{{ addon_variant.price }}"
          >
            {%- unless use_collapsible_select -%}
              <div class="flow-addon__item-toggle">
                {%- if activation == 'checkbox' -%}
                  <input
                    type="checkbox"
                    class="flow-addon__checkbox"
                    id="addon-{{ block.id }}-{{ addon_variant.id }}"
                    data-flow-addon-toggle
                    aria-label="{{ addon_product.title | escape }}"
                    {% if is_preselected %}checked{% endif %}
                  >
                {%- else -%}
                  <button
                    type="button"
                    class="flow-addon__toggle-btn"
                    data-flow-addon-toggle
                    aria-pressed="{% if is_preselected %}true{% else %}false{% endif %}"
                    aria-label="{{ addon_product.title | escape }}"
                  >
                    <span class="flow-addon__toggle-track">
                      <span class="flow-addon__toggle-thumb"></span>
                    </span>
                  </button>
                {%- endif -%}
              </div>
            {%- endunless -%}

            <div class="flow-addon__item-info">
              {%- if addon_product.featured_image -%}
                <div class="flow-addon__item-image">
                  {{ addon_product.featured_image | image_url: width: 120 | image_tag: class: 'flow-addon__img' }}
                </div>
              {%- endif -%}
              <div class="flow-addon__item-details">
                <div class="flow-addon__title-row">
                  <span class="flow-addon__item-title">{{ addon_product.title }}</span>

                  {%- if badges_lines and badges_lines.size > 0 -%}
                    <div class="flow-addon__badges">
                      {%- for line in badges_lines -%}
                        {%- assign row = line | strip -%}
                        {%- if row != blank -%}
                          {%- assign parts = row | split: '|' -%}
                          {%- assign pos = parts[0] | strip | plus: 0 -%}
                          {%- if pos == forloop.parentloop.index -%}
                            {%- assign badge_text = parts[1] | strip -%}
                            {%- assign badge_bg = parts[2] | strip -%}
                            {%- assign badge_fg = parts[3] | strip -%}

                            {%- if badge_text != blank -%}
                              <span
                                class="flow-addon__badge"
                                style="
                                  {%- if badge_bg != blank -%}background: {{ badge_bg }};{%- endif -%}
                                  {%- if badge_fg != blank -%}color: {{ badge_fg }};{%- endif -%}
                                "
                              >
                                {{ badge_text }}
                              </span>
                            {%- endif -%}
                          {%- endif -%}
                        {%- endif -%}
                      {%- endfor -%}
                    </div>
                  {%- endif -%}
                </div>
                {%- if addon_product.description != blank and display_style == 'card' -%}
                  <span class="flow-addon__item-desc">{{ addon_product.description | strip_html | truncate: 80 }}</span>
                {%- endif -%}
                {%- unless use_collapsible_select -%}
                  <span class="flow-addon__item-price">{{ addon_variant.price | money }}</span>
                {%- endunless -%}
              </div>
            </div>

            {%- if use_collapsible_select -%}
              <div class="flow-addon__collapsible">
                <span class="flow-addon__collapsible-hint">Selecionar variante</span>

                <div
                  class="flow-addon__collapsible-panel"
                  id="addon-collapsible-{{ block.id }}-{{ addon_product.id }}"
                  data-flow-addon-collapsible-panel
                >
                  <div class="flow-addon__variant-picker" role="listbox" aria-label="Variantes de {{ addon_product.title | escape }}">
                    {%- for product_variant in addon_product.variants -%}
                      {%- assign variant_image = product_variant.image | default: addon_product.featured_image -%}
                      <button
                        type="button"
                        class="flow-addon__variant-option"
                        data-flow-addon-variant-option
                        data-variant-id="{{ product_variant.id }}"
                        data-variant-price="{{ product_variant.price }}"
                        data-variant-title="{{ product_variant.title | escape }}"
                        data-variant-price-money="{{ product_variant.price | money | escape }}"
                        aria-pressed="{% if product_variant.id == addon_variant.id %}true{% else %}false{% endif %}"
                      >
                        {%- if variant_image -%}
                          <span class="flow-addon__variant-image-wrapper">
                            {{ variant_image | image_url: width: 120 | image_tag: class: 'flow-addon__variant-image' }}
                          </span>
                        {%- endif -%}
                        <span class="flow-addon__variant-copy">
                          <span class="flow-addon__variant-name">{{ product_variant.title }}</span>
                          <span class="flow-addon__variant-price">{{ product_variant.price | money }}</span>
                        </span>
                      </button>
                    {%- endfor -%}
                  </div>
                </div>
              </div>
            {%- endif -%}

            {%- if block.settings.show_quantity -%}
              <div class="flow-addon__item-quantity">
                <label class="visually-hidden" for="addon-qty-{{ block.id }}-{{ addon_variant.id }}">
                  Quantidade
                </label>
                <input
                  type="number"
                  id="addon-qty-{{ block.id }}-{{ addon_variant.id }}"
                  class="flow-addon__qty-input"
                  data-flow-addon-quantity
                  min="1"
                  max="{{ addon_variant.inventory_quantity | default: 99 }}"
                  value="1"
                  aria-label="Quantidade de {{ addon_product.title | escape }}"
                >
              </div>
            {%- endif -%}
          </div>
        {%- endif -%}
      {%- endfor -%}

    {%- elsif addon_type == 'service' -%}
      {%- for service_product in block.settings.products -%}
        {%- assign service_variant = service_product.selected_or_first_available_variant -%}
        {%- if service_variant -%}
          {%- assign display_name = block.settings.service_display_name | default: service_product.title -%}
            {%- assign pre_pos = block.settings.preselected_position | default: 0 | plus: 0 -%}
            {%- assign is_preselected = false -%}
            {%- if pre_pos > 0 and forloop.index == pre_pos -%}
              {%- assign is_preselected = true -%}
            {%- endif -%}
          <div
            class="flow-addon__item flow-addon__item--service"
            data-addon-variant-id="{{ service_variant.id }}"
            data-addon-quantity="1"
            data-addon-selected="false"
            data-price="{{ service_variant.price }}"
            data-service-add-metadata="{% if block.settings.add_service_metadata %}true{% else %}false{% endif %}"
            data-service-property-key="{{ block.settings.service_property_key }}"
            data-service-property-value="{{ block.settings.service_property_value }}"
            data-service-display-name="{{ display_name | escape }}"
          >
            <div class="flow-addon__item-toggle">
              {%- if activation == 'checkbox' -%}
                <input
                  type="checkbox"
                  class="flow-addon__checkbox"
                  id="addon-svc-{{ block.id }}-{{ service_variant.id }}"
                  data-flow-addon-toggle
                  aria-label="{{ display_name | escape }}"
                  {% if is_preselected %}checked{% endif %}
                >
              {%- else -%}
                <button
                  type="button"
                  class="flow-addon__toggle-btn"
                  data-flow-addon-toggle
                  aria-pressed="{% if is_preselected %}true{% else %}false{% endif %}"
                  aria-label="{{ display_name | escape }}"
                >
                  <span class="flow-addon__toggle-track">
                    <span class="flow-addon__toggle-thumb"></span>
                  </span>
                </button>
              {%- endif -%}
            </div>

            <div class="flow-addon__item-info">
              <div class="flow-addon__item-details">
                <span class="flow-addon__item-title">{{ display_name }}</span>
                <span class="flow-addon__item-price">{{ service_variant.price | money }}</span>
              </div>
            </div>
          </div>
        {%- endif -%}
      {%- endfor -%}
    {%- endif -%}
  </div>
</div>

{% stylesheet %}
  .flow-addon {
    width: 100%;
  }

  .flow-addon__heading {
    font-size: var(--font-size--md);
    margin: 0 0 var(--margin-sm) 0;
  }

  .flow-addon__items {
    display: flex;
    flex-direction: column;
    gap: var(--gap-sm, 8px);
  }

  .flow-addon__item {
    display: flex;
    align-items: center;
    gap: var(--gap-md, 12px);
    padding: var(--padding-sm) var(--padding-md);
    border: 1px solid var(--color-border);
    border-radius: var(--style-border-radius-inputs, 4px);
    transition: border-color var(--animation-speed) ease, background var(--animation-speed) ease;
    cursor: pointer;
  }

  .flow-addon--collapsible_select .flow-addon__item {
    flex-direction: column;
    align-items: stretch;
    gap: var(--gap-sm, 8px);
  }

  .flow-addon--collapsible_select .flow-addon__item-info {
    width: 100%;
  }

  .flow-addon__collapsible {
    width: 100%;
  }

  .flow-addon__collapsible-hint {
    display: none;
    margin-top: 4px;
    font-size: var(--font-size--xs);
    color: rgb(from var(--color-foreground) r g b / 0.75);
  }

  .flow-addon__item--collapsible.flow-addon__item--collapsible-open .flow-addon__collapsible-hint {
    display: block;
  }

  .flow-addon__collapsible-panel {
    margin-top: 0;
    max-height: 0;
    overflow: hidden;
    opacity: 0;
    transition:
      max-height var(--animation-speed) ease,
      opacity var(--animation-speed) ease,
      margin-top var(--animation-speed) ease;
  }

  .flow-addon__collapsible-panel.is-open {
    margin-top: var(--margin-xs);
    opacity: 1;
  }

  .flow-addon__variant-picker {
    display: grid;
    grid-template-columns: repeat(var(--flow-addon-variant-cols-mobile, 2), minmax(0, 1fr));
    gap: 6px;
  }

  @media screen and (min-width: 750px) {
    .flow-addon__variant-picker {
      grid-template-columns: repeat(var(--flow-addon-variant-cols-desktop, 3), minmax(0, 1fr));
      gap: 8px;
    }
  }

  .flow-addon__variant-option {
    border: 1px solid var(--color-border);
    border-radius: calc(var(--style-border-radius-inputs, 4px) - 1px);
    background: var(--color-background);
    display: flex;
    align-items: center;
    justify-content: flex-start;
    cursor: pointer;
    text-align: left;
  }

  .flow-addon[data-variant-card-layout='compact'] .flow-addon__variant-option {
    flex-direction: row;
    gap: 6px;
    padding: 6px 8px;
    min-height: 44px;
  }

  .flow-addon[data-variant-card-layout='full'] .flow-addon__variant-option {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
    padding: 10px;
    min-height: 72px;
  }

  .flow-addon__variant-option[aria-pressed='true'] {
    border-color: var(--color-primary);
    background: rgb(from var(--color-primary) r g b / 0.08);
  }

  .flow-addon__variant-image-wrapper {
    width: 48px;
    height: 48px;
    overflow: hidden;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .flow-addon__variant-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .flow-addon[data-variant-card-layout='full'] .flow-addon__variant-image-wrapper {
    width: 60px;
    height: 60px;
  }

  .flow-addon__variant-copy {
    min-width: 0;
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .flow-addon__variant-name {
    font-size: 0.75rem;
    line-height: 1.2;
    text-align: left;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .flow-addon__variant-price {
    font-size: 0.7rem;
    color: rgb(from var(--color-foreground) r g b / 0.7);
  }

  .flow-addon__item[data-addon-selected="true"] {
    border-color: var(--color-primary);
    background: rgb(from var(--color-primary) r g b / 0.05);
  }

  .flow-addon__item-toggle {
    flex-shrink: 0;
  }

  .flow-addon__checkbox {
    width: 18px;
    height: 18px;
    accent-color: var(--color-primary);
    cursor: pointer;
  }

  /* Toggle button (switch style) */
  .flow-addon__toggle-btn {
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
  }

  .flow-addon__toggle-track {
    display: block;
    width: 36px;
    height: 20px;
    background: rgb(from var(--color-foreground) r g b / 0.2);
    border-radius: 10px;
    position: relative;
    transition: background var(--animation-speed) ease;
  }

  .flow-addon__toggle-btn[aria-pressed="true"] .flow-addon__toggle-track {
    background: var(--color-primary);
  }

  .flow-addon__toggle-thumb {
    display: block;
    width: 16px;
    height: 16px;
    background: #fff;
    border-radius: 50%;
    position: absolute;
    top: 2px;
    left: 2px;
    transition: transform var(--animation-speed) ease;
  }

  .flow-addon__toggle-btn[aria-pressed="true"] .flow-addon__toggle-thumb {
    transform: translateX(16px);
  }

  .flow-addon__item-info {
    display: flex;
    align-items: center;
    gap: var(--gap-sm, 8px);
    flex: 1;
    min-width: 0;
  }

  .flow-addon__item-image {
    flex-shrink: 0;
    width: 60px;
    height: 60px;
    overflow: hidden;
    border-radius: var(--style-border-radius-inputs, 4px);
  }

  .flow-addon__img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .flow-addon__item-details {
    display: flex;
    flex-direction: column;
    gap: 2px;
    min-width: 0;
  }

  .flow-addon__item-title {
    font-size: var(--font-size--sm);
    font-weight: 500;
    color: var(--color-foreground);
  }

  .flow-addon__item-desc {
    font-size: var(--font-size--xs);
    color: rgb(from var(--color-foreground) r g b / 0.6);
  }

  .flow-addon__item-price {
    font-size: var(--font-size--sm);
    color: var(--color-foreground);
  }

  .flow-addon__item-quantity {
    flex-shrink: 0;
  }

  .flow-addon__qty-input {
    width: 3.5rem;
    text-align: center;
    padding: var(--padding-xs) var(--padding-sm);
    font-size: var(--font-size--sm);
    border: 1px solid var(--color-input-border);
    border-radius: var(--style-border-radius-inputs, 4px);
    background: var(--color-input-background);
    color: var(--color-input-text);
  }

  /* Compact style */
  .flow-addon--compact .flow-addon__item {
    padding: var(--padding-xs) var(--padding-sm);
  }

  .flow-addon--compact .flow-addon__item-image {
    width: 40px;
    height: 40px;
  }

  .flow-addon__title-row {
  display: flex;
  align-items: center;
  gap: var(--flow-badge-gap, 6px);
  flex-wrap: wrap;
}

.flow-addon__badges {
  display: inline-flex;
  align-items: center;
  gap: var(--flow-badge-gap, 6px);
  flex-wrap: wrap;
}

.flow-addon__badge {
  display: inline-flex;
  align-items: center;
  padding: var(--flow-badge-pad-y, 2px) var(--flow-badge-pad-x, 8px);
  border-radius: var(--flow-badge-radius, 12px);
  font-size: var(--font-size--xs);
  line-height: 1;
  white-space: nowrap;
  background: #111;
  color: #fff;
}


{% endstylesheet %}

{% schema %}
{
  "name": "Addons do produto",
  "tag": null,
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Título da seção de addons",
      "default": "Adicionar extras"
    },
    {
      "type": "select",
      "id": "addon_type",
      "label": "Tipo de addon",
      "options": [
        {
          "value": "product",
          "label": "Produto"
        },
        {
          "value": "service",
          "label": "Serviço"
        }
      ],
      "default": "product"
    },
    {
      "type": "product_list",
      "id": "products",
      "label": "Produtos",
      "limit": 20
    },
    {
      "type": "select",
      "id": "selection_mode",
      "label": "Seleção",
      "options": [
        { "value": "any", "label": "Qualquer" },
        { "value": "single", "label": "Apenas uma" }
      ],
      "default": "any"
    },
    {
      "type": "header",
      "content": "t:content.appearance"
    },
    {
      "type": "select",
      "id": "display_style",
      "label": "Estilo de exibição",
      "options": [
        {
          "value": "card",
          "label": "Card"
        },
        {
          "value": "compact",
          "label": "Compacto"
        },
        {
          "value": "collapsible_select",
          "label": "Select colapsável (variantes)"
        }
      ],
      "default": "card"
    },

    {
      "type": "select",
      "id": "variant_card_layout",
      "label": "Layout do card da variante",
      "options": [
        { "value": "compact", "label": "Compacto" },
        { "value": "full", "label": "Completo" }
      ],
      "default": "compact"
    },
    {
      "type": "range",
      "id": "variant_columns_mobile",
      "label": "Colunas variantes (mobile)",
      "min": 1,
      "max": 3,
      "step": 1,
      "default": 2
    },
    {
      "type": "range",
      "id": "variant_columns_desktop",
      "label": "Colunas variantes (desktop)",
      "min": 1,
      "max": 6,
      "step": 1,
      "default": 3
    },
    {
      "type": "select",
      "id": "activation_method",
      "label": "Método de ativação",
      "options": [
        {
          "value": "checkbox",
          "label": "Checkbox"
        },
        {
          "value": "toggle",
          "label": "Toggle"
        }
      ],
      "default": "checkbox"
    },
    {
      "type": "number",
      "id": "preselected_position",
      "label": "Pré-selecionar item (posição)",
      "default": 0,
      "info": "Use 1 para o primeiro, 2 para o segundo. 0 desativa.",
    },
    {
      "type": "checkbox",
      "id": "show_quantity",
      "label": "Mostrar seletor de quantidade",
      "default": false,
      "visible_if": "{{ block.settings.addon_type == 'product' }}"
    },
    {
      "type": "header",
      "content": "Serviço",
      "visible_if": "{{ block.settings.addon_type == 'service' }}"
    },

    {
      "type": "checkbox",
      "id": "add_service_metadata",
      "label": "Adicionar metadados de serviço no carrinho",
      "default": true,
      "visible_if": "{{ block.settings.addon_type == 'service' }}"
    },
    {
      "type": "text",
      "id": "service_property_key",
      "label": "Chave da propriedade do serviço",
      "default": "_service_type",
      "info": "Prefixo _ torna a propriedade oculta no storefront.",
      "visible_if": "{{ block.settings.addon_type == 'service' }}"
    },
    {
      "type": "text",
      "id": "service_property_value",
      "label": "Valor da propriedade do serviço",
      "default": "producao",
      "visible_if": "{{ block.settings.addon_type == 'service' }}"
    },
    {
      "type": "text",
      "id": "service_display_name",
      "label": "Nome de exibição do serviço",
      "info": "Substitui o título do produto no step e no carrinho. Aceita metafield.",
      "visible_if": "{{ block.settings.addon_type == 'service' }}"
    },
    {
      "type": "header",
      "content": "Badges",
    },
    {
      "type": "richtext",
      "id": "badges_config",
      "label": "Configuração de badges",
      "info": "Formato por linha: posição|texto|#HEX fundo|#HEX texto. Ex: 1|Mais vendido|#111111|#FFFFFF",
    },
    {
      "type": "range",
      "id": "badge_padding_y",
      "label": "Badge padding vertical (px)",
      "min": 0,
      "max": 20,
      "step": 1,
      "default": 2,
    },
    {
      "type": "range",
      "id": "badge_padding_x",
      "label": "Badge padding horizontal (px)",
      "min": 0,
      "max": 30,
      "step": 1,
      "default": 8,
    },
    {
      "type": "range",
      "id": "badge_gap",
      "label": "Gap entre badges (px)",
      "min": 0,
      "max": 20,
      "step": 1,
      "default": 6,
    },
    {
      "type": "range",
      "id": "badge_radius",
      "label": "Arredondamento (px)",
      "min": 0,
      "max": 40,
      "step": 1,
      "default": 12,
    }
  ],
  "presets": [
    {
      "name": "Addons do produto",
      "category": "Fluxo TAP"
    }
  ]
}
{% endschema %}
