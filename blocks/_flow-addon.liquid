{%- doc -%}
  Addon block within _flow-product-form. Two modes:
  - product: cards with checkbox/toggle + quantity. Products via product_list.
  - service: simple toggles. Hidden in cart (private property _service_type),
    visible in checkout. Uses _display_name for consistent naming.

  DOM contract (see plan sec. 5.1):
    data-flow-addon, data-addon-type (product|service)
    Per item: data-addon-variant-id, data-addon-quantity, data-addon-selected
    Service extras: data-service-property-key, data-service-property-value, data-service-display-name
    Price: data-price (in cents)

  @param {select} addon_type - product | service
  @param {product_list} products - Products to show as addons (product type)
  @param {select} display_style - card | compact
  @param {select} activation_method - checkbox | toggle
  @param {checkbox} show_quantity - Show quantity selector (product type only)
  @param {text} service_property_key - Property key for service (default: _service_type)
  @param {text} service_display_name - Display name override for cart/step
{%- enddoc -%}

{%- liquid
  assign addon_type = block.settings.addon_type | default: 'product'
  assign display_style = block.settings.display_style | default: 'card'
  assign activation = block.settings.activation_method | default: 'checkbox'
-%}

<div
  class="flow-addon flow-addon--{{ addon_type }} flow-addon--{{ display_style }}"
  {{ block.shopify_attributes }}
  data-flow-addon
  data-addon-type="{{ addon_type }}"
  data-selection-mode="{{ block.settings.selection_mode | default: 'any' }}"
>
  {%- if block.settings.heading != blank -%}
    <h3 class="flow-addon__heading">{{ block.settings.heading }}</h3>
  {%- endif -%}

  <div class="flow-addon__items">
    {%- if addon_type == 'product' -%}
      {%- for addon_product in block.settings.products -%}
        {%- assign addon_variant = addon_product.selected_or_first_available_variant -%}
        {%- if addon_variant -%}
          <div
            class="flow-addon__item flow-addon__item--product"
            data-addon-variant-id="{{ addon_variant.id }}"
            data-addon-quantity="1"
            data-addon-selected="false"
            data-price="{{ addon_variant.price }}"
          >
            <div class="flow-addon__item-toggle">
              {%- if activation == 'checkbox' -%}
                <input
                  type="checkbox"
                  class="flow-addon__checkbox"
                  id="addon-{{ block.id }}-{{ addon_variant.id }}"
                  data-flow-addon-toggle
                  aria-label="{{ addon_product.title | escape }}"
                >
              {%- else -%}
                <button
                  type="button"
                  class="flow-addon__toggle-btn"
                  data-flow-addon-toggle
                  aria-pressed="false"
                  aria-label="{{ addon_product.title | escape }}"
                >
                  <span class="flow-addon__toggle-track">
                    <span class="flow-addon__toggle-thumb"></span>
                  </span>
                </button>
              {%- endif -%}
            </div>

            <div class="flow-addon__item-info">
              {%- if addon_product.featured_image -%}
                <div class="flow-addon__item-image">
                  {{ addon_product.featured_image | image_url: width: 120 | image_tag: class: 'flow-addon__img' }}
                </div>
              {%- endif -%}
              <div class="flow-addon__item-details">
                <span class="flow-addon__item-title">{{ addon_product.title }}</span>
                {%- if addon_product.description != blank and display_style == 'card' -%}
                  <span class="flow-addon__item-desc">{{ addon_product.description | strip_html | truncate: 80 }}</span>
                {%- endif -%}
                <span class="flow-addon__item-price">{{ addon_variant.price | money }}</span>
              </div>
            </div>

            {%- if block.settings.show_quantity -%}
              <div class="flow-addon__item-quantity">
                <label class="visually-hidden" for="addon-qty-{{ block.id }}-{{ addon_variant.id }}">
                  Quantidade
                </label>
                <input
                  type="number"
                  id="addon-qty-{{ block.id }}-{{ addon_variant.id }}"
                  class="flow-addon__qty-input"
                  data-flow-addon-quantity
                  min="1"
                  max="{{ addon_variant.inventory_quantity | default: 99 }}"
                  value="1"
                  aria-label="Quantidade de {{ addon_product.title | escape }}"
                >
              </div>
            {%- endif -%}
          </div>
        {%- endif -%}
      {%- endfor -%}

    {%- elsif addon_type == 'service' -%}
      {%- for service_product in block.settings.products -%}
        {%- assign service_variant = service_product.selected_or_first_available_variant -%}
        {%- if service_variant -%}
          {%- assign display_name = block.settings.service_display_name | default: service_product.title -%}
          <div
            class="flow-addon__item flow-addon__item--service"
            data-addon-variant-id="{{ service_variant.id }}"
            data-addon-quantity="1"
            data-addon-selected="false"
            data-price="{{ service_variant.price }}"
            data-service-property-key="{{ block.settings.service_property_key | default: '_service_type' }}"
            data-service-property-value="{{ block.settings.service_property_value | default: 'service' }}"
            data-service-display-name="{{ display_name | escape }}"
          >
            <div class="flow-addon__item-toggle">
              {%- if activation == 'checkbox' -%}
                <input
                  type="checkbox"
                  class="flow-addon__checkbox"
                  id="addon-svc-{{ block.id }}-{{ service_variant.id }}"
                  data-flow-addon-toggle
                  aria-label="{{ display_name | escape }}"
                >
              {%- else -%}
                <button
                  type="button"
                  class="flow-addon__toggle-btn"
                  data-flow-addon-toggle
                  aria-pressed="false"
                  aria-label="{{ display_name | escape }}"
                >
                  <span class="flow-addon__toggle-track">
                    <span class="flow-addon__toggle-thumb"></span>
                  </span>
                </button>
              {%- endif -%}
            </div>

            <div class="flow-addon__item-info">
              <div class="flow-addon__item-details">
                <span class="flow-addon__item-title">{{ display_name }}</span>
                <span class="flow-addon__item-price">{{ service_variant.price | money }}</span>
              </div>
            </div>
          </div>
        {%- endif -%}
      {%- endfor -%}
    {%- endif -%}
  </div>
</div>

{% stylesheet %}
  .flow-addon {
    width: 100%;
  }

  .flow-addon__heading {
    font-size: var(--font-size--md);
    margin: 0 0 var(--margin-sm) 0;
  }

  .flow-addon__items {
    display: flex;
    flex-direction: column;
    gap: var(--gap-sm, 8px);
  }

  .flow-addon__item {
    display: flex;
    align-items: center;
    gap: var(--gap-md, 12px);
    padding: var(--padding-sm) var(--padding-md);
    border: 1px solid var(--color-border);
    border-radius: var(--style-border-radius-inputs, 4px);
    transition: border-color var(--animation-speed) ease, background var(--animation-speed) ease;
    cursor: pointer;
  }

  .flow-addon__item[data-addon-selected="true"] {
    border-color: var(--color-primary);
    background: rgb(from var(--color-primary) r g b / 0.05);
  }

  .flow-addon__item-toggle {
    flex-shrink: 0;
  }

  .flow-addon__checkbox {
    width: 18px;
    height: 18px;
    accent-color: var(--color-primary);
    cursor: pointer;
  }

  /* Toggle button (switch style) */
  .flow-addon__toggle-btn {
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
  }

  .flow-addon__toggle-track {
    display: block;
    width: 36px;
    height: 20px;
    background: rgb(from var(--color-foreground) r g b / 0.2);
    border-radius: 10px;
    position: relative;
    transition: background var(--animation-speed) ease;
  }

  .flow-addon__toggle-btn[aria-pressed="true"] .flow-addon__toggle-track {
    background: var(--color-primary);
  }

  .flow-addon__toggle-thumb {
    display: block;
    width: 16px;
    height: 16px;
    background: #fff;
    border-radius: 50%;
    position: absolute;
    top: 2px;
    left: 2px;
    transition: transform var(--animation-speed) ease;
  }

  .flow-addon__toggle-btn[aria-pressed="true"] .flow-addon__toggle-thumb {
    transform: translateX(16px);
  }

  .flow-addon__item-info {
    display: flex;
    align-items: center;
    gap: var(--gap-sm, 8px);
    flex: 1;
    min-width: 0;
  }

  .flow-addon__item-image {
    flex-shrink: 0;
    width: 60px;
    height: 60px;
    overflow: hidden;
    border-radius: var(--style-border-radius-inputs, 4px);
  }

  .flow-addon__img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .flow-addon__item-details {
    display: flex;
    flex-direction: column;
    gap: 2px;
    min-width: 0;
  }

  .flow-addon__item-title {
    font-size: var(--font-size--sm);
    font-weight: 500;
    color: var(--color-foreground);
  }

  .flow-addon__item-desc {
    font-size: var(--font-size--xs);
    color: rgb(from var(--color-foreground) r g b / 0.6);
  }

  .flow-addon__item-price {
    font-size: var(--font-size--sm);
    color: var(--color-foreground);
  }

  .flow-addon__item-quantity {
    flex-shrink: 0;
  }

  .flow-addon__qty-input {
    width: 3.5rem;
    text-align: center;
    padding: var(--padding-xs) var(--padding-sm);
    font-size: var(--font-size--sm);
    border: 1px solid var(--color-input-border);
    border-radius: var(--style-border-radius-inputs, 4px);
    background: var(--color-input-background);
    color: var(--color-input-text);
  }

  /* Compact style */
  .flow-addon--compact .flow-addon__item {
    padding: var(--padding-xs) var(--padding-sm);
  }

  .flow-addon--compact .flow-addon__item-image {
    width: 40px;
    height: 40px;
  }
{% endstylesheet %}

{% schema %}
{
  "name": "Addons do produto",
  "tag": null,
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Título da seção de addons",
      "default": "Adicionar extras"
    },
    {
      "type": "select",
      "id": "addon_type",
      "label": "Tipo de addon",
      "options": [
        {
          "value": "product",
          "label": "Produto"
        },
        {
          "value": "service",
          "label": "Serviço"
        }
      ],
      "default": "product"
    },
    {
      "type": "product_list",
      "id": "products",
      "label": "Produtos",
      "limit": 20
    },
    {
      "type": "select",
      "id": "selection_mode",
      "label": "Seleção",
      "options": [
        { "value": "any", "label": "Qualquer" },
        { "value": "single", "label": "Apenas uma" }
      ],
      "default": "any",
    },
    {
      "type": "header",
      "content": "t:content.appearance"
    },
    {
      "type": "select",
      "id": "display_style",
      "label": "Estilo de exibição",
      "options": [
        {
          "value": "card",
          "label": "Card"
        },
        {
          "value": "compact",
          "label": "Compacto"
        }
      ],
      "default": "card"
    },
    {
      "type": "select",
      "id": "activation_method",
      "label": "Método de ativação",
      "options": [
        {
          "value": "checkbox",
          "label": "Checkbox"
        },
        {
          "value": "toggle",
          "label": "Toggle"
        }
      ],
      "default": "checkbox"
    },
    {
      "type": "checkbox",
      "id": "show_quantity",
      "label": "Mostrar seletor de quantidade",
      "default": false,
      "visible_if": "{{ block.settings.addon_type == 'product' }}"
    },
    {
      "type": "header",
      "content": "Serviço",
      "visible_if": "{{ block.settings.addon_type == 'service' }}"
    },
    {
      "type": "text",
      "id": "service_property_key",
      "label": "Chave da propriedade do serviço",
      "default": "_service_type",
      "info": "Prefixo _ torna a propriedade oculta no storefront.",
      "visible_if": "{{ block.settings.addon_type == 'service' }}"
    },
    {
      "type": "text",
      "id": "service_property_value",
      "label": "Valor da propriedade do serviço",
      "default": "producao",
      "visible_if": "{{ block.settings.addon_type == 'service' }}"
    },
    {
      "type": "text",
      "id": "service_display_name",
      "label": "Nome de exibição do serviço",
      "info": "Substitui o título do produto no step e no carrinho. Aceita metafield.",
      "visible_if": "{{ block.settings.addon_type == 'service' }}"
    }
  ],
  "presets": [
    {
      "name": "Addons do produto",
      "category": "Fluxo TAP"
    }
  ]
}
{% endschema %}
